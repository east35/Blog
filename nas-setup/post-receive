#!/bin/bash
# Git post-receive hook for auto-deployment
# Place this file in: /volume1/docker/blog/blog.git/hooks/post-receive

set -e

# Configuration
WORK_TREE="/volume1/docker/blog/site"
GIT_DIR="/volume1/docker/blog/blog.git"

echo "==> Deploying blog..."

# Checkout the latest version
git --work-tree=$WORK_TREE --git-dir=$GIT_DIR checkout -f main

# Navigate to work tree
cd $WORK_TREE

# Install dependencies (only if package.json changed)
if git diff-tree --name-only --no-commit-id -r HEAD | grep -q "package.json"; then
    echo "==> Installing dependencies..."
    npm install
fi

# Build the site
echo "==> Building site..."
npm run build

# Restart Docker container to pick up changes
echo "==> Restarting Docker container..."
cd /volume1/docker/blog
docker-compose restart blog

echo "==> Deployment complete!"
